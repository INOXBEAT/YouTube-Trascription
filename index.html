<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video de YouTube con Subtítulos Dinámicos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- Estilos CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #003057;
            margin: 20px 0;
        }

        .form-container {
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-container label {
            font-weight: bold;
        }

        .form-container button {
            background-color: #003057;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .form-container button:hover {
            background-color: #00569c;
        }

        #full-transcript-container {
            background-color: #f9f9f9;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 360px;
            overflow-y: auto;
        }

        .highlight {
            background-color: yellow;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        .video-container {
            display: flex;
            justify-content: space-between;
        }

        .video-container #player {
            flex: 0 0 70%;
            height: 360px;
        }

        .video-container #full-transcript-container {
            flex: 0 0 30%;
            max-height: 360px;
        }
    </style>

</head>

<body>
    <!-- Contenedor del formulario y el video -->
    <div class="container">
        <h1>Video de YouTube con Subtítulos Dinámicos</h1>
        
        <!-- Formulario para ingresar la URL del video y cargar el archivo de transcripción -->
        <div class="form-container">
            <form id="video-form">
                <div class="mb-3">
                    <label for="videoUrl" class="form-label">URL del Video:</label>
                    <input type="text" class="form-control" id="videoUrl" name="videoUrl" placeholder="Ingresa una URL de video de YOUTUBE" required>
                </div>
                <div class="mb-3">
                    <label for="fileInput" class="form-label">Archivo de Transcripción:</label>
                    <input type="file" class="form-control" id="fileInput" required>
                </div>
                <button type="submit" class="btn btn-primary">Generar</button>
            </form>
        </div>

        <!-- Contenedor para el video y la transcripción -->
        <div class="video-container">
            <div id="player"></div>
            <div id="full-transcript-container"></div>
        </div>
    </div>

    <!-- JavaScript con las funciones del sistema -->
    <script type="text/javascript">
        var player;
        var subtitles = [];
        var subtitleElements = [];

        // Función llamada por la API de YouTube para inicializar el reproductor
        function onYouTubeIframeAPIReady() { }

        // Función llamada cuando el reproductor de YouTube está listo
        function onPlayerReady(event) {
            event.target.playVideo();
            checkTime(); // Iniciar la función de tiempo para resaltar subtítulos
        }

        // Función para verificar el tiempo del video y resaltar subtítulos
        function checkTime() {
            var currentTime = player.getCurrentTime();
            subtitles.forEach(function (subtitle, index) {
                var subtitleElement = subtitleElements[index];
                var nextSubtitleTime = (index + 1 < subtitles.length) ? subtitles[index + 1].time : player.getDuration();

                if (currentTime >= subtitle.time && currentTime < nextSubtitleTime) {
                    subtitleElement.classList.add('highlight');
                } else {
                    subtitleElement.classList.remove('highlight');
                }
            });
            requestAnimationFrame(checkTime); // Continuar revisando el tiempo
        }

        // Manejar el envío del formulario
        document.getElementById('video-form').addEventListener('submit', function (e) {
            e.preventDefault();
            var videoUrl = document.getElementById('videoUrl').value;
            var fileInput = document.getElementById('fileInput');
            var file = fileInput.files[0];

            if (!file) {
                alert("Por favor, cargue un archivo de transcripción.");
                return;
            }

            if (!videoUrl) {
                alert("Por favor, ingrese una URL de YouTube válida.");
                return;
            }

            // Extraer el ID del video de YouTube de la URL
            function extractVideoId(url) {
                var videoIdMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                return videoIdMatch ? videoIdMatch[1] : null;
            }

            var videoId = extractVideoId(videoUrl);
            if (!videoId) {
                alert("URL de YouTube inválida.");
                return;
            }

            // Destruir el reproductor existente si ya hay uno
            if (player) {
                player.destroy();
                document.getElementById('full-transcript-container').innerHTML = "";
                subtitleElements = [];
            }

            // Crear un nuevo reproductor de YouTube
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                events: {
                    'onReady': onPlayerReady
                }
            });

            // Procesar el archivo de transcripción
            const reader = new FileReader();
            reader.onload = function (e) {
                const lines = e.target.result.split('\n');
                subtitles = [];
                let time = null;

                // Analizar el archivo de transcripción
                lines.forEach(line => {
                    line = line.trim();
                    const timeMatch = line.match(/^(\d{1,2}):(\d{2})$/);
                    if (timeMatch) {
                        const minutes = parseInt(timeMatch[1], 10);
                        const seconds = parseInt(timeMatch[2], 10);
                        time = minutes * 60 + seconds;
                    } else if (time !== null) {
                        subtitles.push({ time: time, text: line });
                        time = null;
                    }
                });

                // Mostrar la transcripción completa
                displayFullTranscript();
            };

            reader.readAsText(file);
        });

        // Función para mostrar la transcripción completa
        function displayFullTranscript() {
            var fullTranscriptContainer = document.getElementById('full-transcript-container');
            fullTranscriptContainer.innerHTML = ''; // Limpiar contenido anterior
            subtitleElements = [];

            subtitles.forEach(function (subtitle, index) {
                var p = document.createElement('p');
                var a = document.createElement('a');
                a.innerText = subtitle.text;
                a.href = "#";
                a.onclick = function () {
                    player.seekTo(subtitle.time, true);
                    return false;
                };
                p.appendChild(a);
                fullTranscriptContainer.appendChild(p);
                subtitleElements.push(p);
            });
        }
    </script>
</body>

</html>
