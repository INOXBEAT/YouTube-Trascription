<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video de YouTube con Subtítulos Dinámicos</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        .highlight {
            background-color: yellow;
        }
    </style>
</head>

<body>
    <h1>Video de YouTube con Subtítulos Dinámicos</h1>
    <form id="video-form">
        <label for="videoUrl">URL del Video:</label>
        <input type="text" id="videoUrl" name="videoUrl" required />
        <br>
        <input type="file" id="fileInput" required />
        <button type="submit">Generar</button>
    </form>
    <div id="player"></div>
    <div id="full-transcript-container"></div> <!-- Contenedor para la transcripción completa -->

    <script type="text/javascript">
        var player;
        var subtitles = [];
        var subtitleElements = [];

        function onYouTubeIframeAPIReady() {}

        function onPlayerReady(event) {
            event.target.playVideo();
            checkTime(); // Iniciar la función de tiempo
        }

        function checkTime() {
            var currentTime = player.getCurrentTime();
            subtitles.forEach(function (subtitle, index) {
                var subtitleElement = subtitleElements[index];
                var nextSubtitleTime = (index + 1 < subtitles.length) ? subtitles[index + 1].time : player.getDuration();

                if (currentTime >= subtitle.time && currentTime < nextSubtitleTime) {
                    subtitleElement.classList.add('highlight');
                } else {
                    subtitleElement.classList.remove('highlight');
                }
            });
            requestAnimationFrame(checkTime);
        }

        document.getElementById('video-form').addEventListener('submit', function (e) {
            e.preventDefault();
            var videoUrl = document.getElementById('videoUrl').value;
            var fileInput = document.getElementById('fileInput');
            var file = fileInput.files[0];

            if (!file) {
                alert("Por favor, cargue un archivo de transcripción.");
                return;
            }

            if (!videoUrl) {
                alert("Por favor, ingrese una URL de YouTube válida.");
                return;
            }

            function extractVideoId(url) {
                var videoIdMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                return videoIdMatch ? videoIdMatch[1] : null;
            }

            var videoId = extractVideoId(videoUrl);
            if (!videoId) {
                alert("URL de YouTube inválida.");
                return;
            }

            if (player) {
                player.destroy();
                document.getElementById('full-transcript-container').innerHTML = "";
                subtitleElements = [];
            }

            // Crear un nuevo reproductor de YouTube
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: videoId,
                events: {
                    'onReady': onPlayerReady
                }
            });

            // Procesar el archivo de transcripción
            const reader = new FileReader();
            reader.onload = function (e) {
                const lines = e.target.result.split('\n');
                subtitles = [];
                let time = null;

                lines.forEach(line => {
                    line = line.trim();
                    const timeMatch = line.match(/^(\d{1,2}):(\d{2})$/);
                    if (timeMatch) {
                        const minutes = parseInt(timeMatch[1], 10);
                        const seconds = parseInt(timeMatch[2], 10);
                        time = minutes * 60 + seconds;
                    } else if (time !== null) {
                        subtitles.push({ time: time, text: line });
                        time = null;
                    }
                });

                console.log(JSON.stringify(subtitles, null, 2));
                displayFullTranscript();
            };

            reader.readAsText(file);
        });

        function displayFullTranscript() {
            var fullTranscriptContainer = document.getElementById('full-transcript-container');
            fullTranscriptContainer.innerHTML = ''; // Limpiar contenido anterior
            subtitleElements = [];

            subtitles.forEach(function (subtitle, index) {
                var p = document.createElement('p');
                var a = document.createElement('a');
                a.innerText = subtitle.text;
                a.href = "#";
                a.onclick = function () {
                    player.seekTo(subtitle.time, true);
                    return false;
                };
                p.appendChild(a);
                fullTranscriptContainer.appendChild(p);
                subtitleElements.push(p);
            });
        }
    </script>
</body>

</html>
